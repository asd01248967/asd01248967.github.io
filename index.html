<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Hexo">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-加入ping與snmp監控到telegraf" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/04/01/加入ping與snmp監控到telegraf/" class="article-date">
  <time datetime="2019-04-01T09:26:53.000Z" itemprop="datePublished">2019-04-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/04/01/加入ping與snmp監控到telegraf/">加入ping與snmp監控到telegraf</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>在前幾篇介紹telegraf的文章片段中只有簡單介紹如何最簡單快入的安裝 &amp; 設定 &amp; 啟動 &amp; 確認服務是否成功執行</p>
<p>但是並沒有針對telegraf設定去做較清楚的講解</p>
<p>本篇文章為使用telegraf的ping與snmp設定範例之一</p>
<p>從預設的系統監控項目額外新增上述兩項的input的監控項目</p>
<p>那麼第一部分主要是先講解telegraf上新增ping的功能</p>
<h1 id="1-default"><a href="#1-default" class="headerlink" title="1. default"></a>1. default</h1>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/04/01/加入ping與snmp監控到telegraf/" data-id="cjudnszty0002vck07eg6ka3i" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Grafana搭配Slack告警與GCS圖片發送" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/28/Grafana搭配Slack告警與GCS圖片發送/" class="article-date">
  <time datetime="2019-03-28T08:35:32.000Z" itemprop="datePublished">2019-03-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/28/Grafana搭配Slack告警與GCS圖片發送/">Grafana搭配Slack告警與GCS圖片發送</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>呈上個主題，建立好dashboard與panel的監控圖表(可以顯示出cpu、disk、ram、network等資訊)</p>
<p>我們需要有一個機制可以在監控圖表突然出現異常(數值不正確)的時候可以發出警通知系統管理人員</p>
<p>並且發送告警監控的截圖來告知系統管理員是哪一個服務或資源發生異常從而告警，目前的值是多少，圖形是如何的趨勢</p>
<h1 id="Configuration-alert"><a href="#Configuration-alert" class="headerlink" title="Configuration alert"></a>Configuration alert</h1><p>step.1 首先先註冊一個slack的帳號與下載slack的應用程序或app</p>
<img src="/2019/03/28/Grafana搭配Slack告警與GCS圖片發送/12.png">
<p>step.2 slack創建一個channel的頻道(也可以說是workspace的地方)，並將需要的管理人員都加入進去</p>
<img src="/2019/03/28/Grafana搭配Slack告警與GCS圖片發送/13.png">
<p>stpe.3 前往slack的app Directory應用程序，登入後選擇所要發送告警通知的channel，搜尋並申請Incoming WebHooks的URL</p>
<p>網址：<a href="https://slack.com/apps" target="_blank" rel="noopener">https://slack.com/apps</a></p>
<img src="/2019/03/28/Grafana搭配Slack告警與GCS圖片發送/14.png">
<p>step.4 回來Grafana的Alerting → notifications channels → New Channel</p>
<img src="/2019/03/28/Grafana搭配Slack告警與GCS圖片發送/01.png">
<p>填上名稱、類型、incoming webhook url之後把send on all alerts與include image給勾選起來後點選save &amp; test<br>會發送一個測試個告警訊息且包含圖片</p>
<img src="/2019/03/28/Grafana搭配Slack告警與GCS圖片發送/02.png">
<p>有收到上圖的告警 &amp; 圖片訊息才能確認告警發送通知是成功的。才可以繼續往下做step.5 告警值的調整</p>
<p>step.5 回到Grafana之前所建立dashboard的cpu、ram、disk等資訊監控的panel，選擇alert頁籤後點選Create Alert。</p>
<p>設定Alert config、condition與no data 與 error handing與Notifications</p>
<img src="/2019/03/28/Grafana搭配Slack告警與GCS圖片發送/03.png">
<p>Rule：此條規則的名稱、多久評估一次值、等待多久從pending 轉為alert的狀態</p>
<p>Conditions：圖例來說，設置值的平均值，query A的值從現在往前5分鐘、超過100 =&gt;符合告警的設定</p>
<p>no data &amp; error handing：設定沒資料與處理錯誤的狀態下該如何判定與處理</p>
<p>Notifications：選擇剛剛在Alerting所設定的Channel(會發送到剛剛建立的slacke channel)後存檔</p>
<p>panel名稱上應該會有一個綠色的愛心符號，即代表你有設定Alter的並且現在是正確的值</p>
<p>如果有跳出異常的值時，此panel會外框變成紅色且愛心會變成紅色碎裂的心</p>
<p>step.6 再來就是測試是否真的可以如設定上發送cpu、ram、disk等監控資訊的告警</p>
<p>假設目前的cpu的正常值為10%，我們把Alter的config調整成會告警的</p>
<h1 id="GCS上傳圖片與發送"><a href="#GCS上傳圖片與發送" class="headerlink" title="GCS上傳圖片與發送"></a>GCS上傳圖片與發送</h1><p>在使用docker-compose建立grafana與influxdb的時候就已經完成的初階的GCP的DNS與OAuth Client 驗證的設定</p>
<p>所以只要有按照該篇文章建立與設定的話目前應該是可以透過網域與google帳號驗證登入進grafana了</p>
<p>那我們在GCP上還差幾個步驟就可以讓grafana上有圖片暫存與收發的功能了</p>
<p>step.1 建立服務帳戶並給予權限<br>此步驟主要是建立一個服務帳號，並給予帳號特定storage的權限，然後讓此帳號升成一個金鑰檔案給予grafana使用，這樣一來grafana就可以拿取此金鑰檔案上擁有的權限認證對特定storage進行存取了</p>
<p>先到IAM與管理員後點選+建立服務帳戶<br><img src="/2019/03/28/Grafana搭配Slack告警與GCS圖片發送/04.png"></p>
<p>填寫服務帳號名稱：這邊可以設定為單一服務或功能型的名稱：grafana or storages for grafana等等…<br>服務帳戶說明：看個人願不願意輸入此服務帳戶的詳細資訊，避免日後太久回來忘記還是建議輸入一下<br><img src="/2019/03/28/Grafana搭配Slack告警與GCS圖片發送/05.png"></p>
<p>設定服務帳戶權限(可選項)：請選擇儲存空間的storages的物件建立者or物件管理員(至少確保有寫入權限)<br>點選繼續之後</p>
<img src="/2019/03/28/Grafana搭配Slack告警與GCS圖片發送/06.png">
<p>再完成後記得點選下載json格式的金鑰，此金鑰為你所創立的服務帳號所授予寫入storage權限的証明<br>有了此金鑰檔案就可以有權限任意的往你的storage新增刪除物件了<br>所以金鑰要很小心的管理不可外流!!!</p>
<img src="/2019/03/28/Grafana搭配Slack告警與GCS圖片發送/07.png">
<p>step.2 建立可以暫存圖片的storage bucket</p>
<p>既然已經完成了建立帳號與權限設定並拿到帳號的金鑰了</p>
<p>那接下來準備建置一個讓grafana可以存取圖片的storage bucket了</p>
<p>點選GCP Menu的Storage 瀏覽器後，按下建立值區(就是bucket的意思)</p>
<img src="/2019/03/28/Grafana搭配Slack告警與GCS圖片發送/09.png">
<p>名稱：因為GCP的bucket的特殊性，全世界的bucket不可以有相同的名稱，因此請自己取一個符合服務或功能性的名稱<br>如果出現重複名稱GCP會有紅色通知你需要更換名稱<br>預設儲存空間級別：依照個人需求，假設你上傳與下載圖片頻率越高，則使用Multi-Regional；反之則選擇約低層級就好<br>詳細的費用計算方法請參考這裡[<a href="https://cloud.google.com/storage/pricing]" target="_blank" rel="noopener">https://cloud.google.com/storage/pricing]</a></p>
<img src="/2019/03/28/Grafana搭配Slack告警與GCS圖片發送/08.png">
<p><br></p>
<font color="blue">請注意將你剛剛下載下載的json金鑰檔案放置在/data/grafana底下。<br>因為容器內的路徑對應到外部的/data/grafana資料夾，因此丟到此路徑就可以讓容器讀取金鑰</font>

<p>step.3 新增gcs的configuration至docker-compose上</p>
<p>目前的docker-compose.yml尚未有gcs的上傳圖片功能</p>
<p>所以我們在這邊要新增這些環境變數上去設定來新鄒此功能</p>
<pre><code>environment:
  - GF_EXTERNAL_IMAGE_STORAGE_PROVIDER=gcs
  - GF_EXTERNAL_IMAGE_STORAGE_GCS_KEY_FILE=/var/lib/grafana/at-test-167906-dc5790273dac.json
  - GF_EXTERNAL_IMAGE_STORAGE_GCS_BUCKET=kasper-test
</code></pre><p>第一個環境變數是指你要選擇使用gcs當作圖片的存放空間(記得要小寫，大寫會出錯)<br>第二個環境變數是指你的服務帳號的金鑰放置位置<br>第二個環境變數是指你的bucket的名稱</p>
<p>備註1：金鑰的部分，因為我們將grafana持久化，將容器世界的/var/lib/grafana對應到外部主機的/data/grafana，因此我建議就將禁要放置在此。然後把金鑰的位置設定成容器內部的/var/lib/grafana<br>即可以抓到金鑰檔案了</p>
<p>備註2：Bucket的名稱只要打單純的bucket名稱即可，不需要在前面增加任何網路的路徑等等</p>
<p>後續在建立grafana與influxdb的時候需要查看log是否有正確的讀取到設定檔與抓取該金鑰檔案</p>
<p>可以使用已下指令來查看</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker logs grafana</span><br></pre></td></tr></table></figure>
<p>正確的話會出現以下log<br>如果沒有出現的話就帶柄環境變數設定錯誤or讀取金鑰失敗<br><img src="/2019/03/28/Grafana搭配Slack告警與GCS圖片發送/10.png"></p>
<img src="/2019/03/28/Grafana搭配Slack告警與GCS圖片發送/11.png">

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/03/28/Grafana搭配Slack告警與GCS圖片發送/" data-id="cjudnsztn0000vck0vhrhymgf" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-搭配Grafana的資料收集器Telegraf" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/28/搭配Grafana的資料收集器Telegraf/" class="article-date">
  <time datetime="2019-03-28T06:15:35.000Z" itemprop="datePublished">2019-03-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/28/搭配Grafana的資料收集器Telegraf/">搭配Grafana的資料收集器Telegraf</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="介紹"><a href="#介紹" class="headerlink" title="介紹"></a>介紹</h1><ul>
<li>telegraf 是用Go寫的代理程式，可以用在收集系統和服務的統計資料，它擁有輸入套件，可以直接從系統抓取指標數據，從第三方API獲得指標數據，甚至可以通過statsd和Kafka得到資料。它還具備输出套件，可以將採集的數據發送到各種資料庫儲存。比如InfluxDB，Graphite，OpenTSDB，Datadog，Librato，Kafka，MQTT，NSQ等等。支援 Linux  與 Windows。</li>
</ul>
<img src="/2019/03/28/搭配Grafana的資料收集器Telegraf/01.png">
<h1 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h1><p>成上一個主題Grafana與Influxdb安裝完後開始要建立DashBoard進行資料視覺化分析了<br>但是因為目前Influxdb還沒開始建造存在Metric的資料庫因此無法拉取Metric繪畫成圖片</p>
<p>因此安裝Telegraf並設定收集設定的機器資料然後傳送到Influxdb的8086 Port，就是Telergaf最主要的功能了!</p>
<p>接下來是安裝教學<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://dl.influxdata.com/telegraf/releases/telegraf_1.9.5-1_amd64.deb</span><br></pre></td></tr></table></figure></p>
<p>下載Telegraf的安裝包<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo dpkg -i telegraf_1.9.5-1_amd64.deb</span><br></pre></td></tr></table></figure></p>
<p>解壓縮並安裝<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/telegraf/telegraf.conf</span><br></pre></td></tr></table></figure></p>
<p>修改設定檔<br>將config內的設定檔照以下的資訊設定完成</p>
<ul>
<li>logfile = “/var/log/telegraf/telegraf.log”</li>
<li></li>
<li>urls = [“<a href="http://127.0.0.1:8086&quot;]" target="_blank" rel="noopener">http://127.0.0.1:8086&quot;]</a></li>
<li></li>
<li>database = “telegraf”</li>
</ul>
<p>logfile：主要是將telegraf的log檔案指定在特定路徑下<br>urls：指定要telegraf將收集的資料丟往哪一個資料庫存放<br>database：指定在丟資料時要存放進哪一個資料庫<br>儲存好了之後重啟服務 &amp; 確認服務<font color="Green">Running</font></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ service telegraf restart</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ service telegraf status</span><br></pre></td></tr></table></figure>
<img src="/2019/03/28/搭配Grafana的資料收集器Telegraf/02.png">
<h1 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h1><p>之後telegraf會將電腦的預設系統資訊傳送到influxdb，telegra的configuration有著最低配置的系統資料收集，CPU、RAM、DISK、NETWORK..等等<br>現在照著把上述資訊給拉出圖表來觀看</p>
<p>step.1 先登入到Grafana後點選Configuration → Data Source → InfluxDB，照著下列資訊設定</p>
<ul>
<li>URL ：<a href="http://influxdb:8086" target="_blank" rel="noopener">http://influxdb:8086</a></li>
<li>Database ：telegraf<br>之後點選save &amp; test</li>
</ul>
<p>step.2 點選左上的 ＋ → Dashboard → Add Query<br>照以下的圖片設定即可已出現cpu的繪圖</p>
<img src="/2019/03/28/搭配Grafana的資料收集器Telegraf/03.png">
<p>-<br><img src="/2019/03/28/搭配Grafana的資料收集器Telegraf/04.png"></p>
<p>-<br><img src="/2019/03/28/搭配Grafana的資料收集器Telegraf/05.png"></p>
<p>後續要加上其餘的記憶體與硬碟與網路封包等都可以再剛剛顯示cpu的選項調整<br>cpu的位置是Input的類別(e.q 硬碟、記憶體、網路、程序、系統、io量等)<br>where是選擇host或者是更細部的子類別選項等<br>select是該類別下的所有被收集來的資訊(e.q 硬碟大小、容量、使用量、空閒等)<br>Group By 的time是時間區間與，fill是值的表現方式</p>
<p>之後會再寫一篇介紹telegraf怎麼加入ping與snmp的功能<br>主要也是針對configuration的部分新增ping與snmp的input的段落</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/03/28/搭配Grafana的資料收集器Telegraf/" data-id="cjudnszw00004vck0lr5bzqks" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-docker-compose建立Grafana與Influxdb" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/27/docker-compose建立Grafana與Influxdb/" class="article-date">
  <time datetime="2019-03-27T06:12:02.000Z" itemprop="datePublished">2019-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/27/docker-compose建立Grafana與Influxdb/">docker-compose建立Grafana與Influxdb</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>系統：Ubuntu 16.04 LTS</p>
<p>#介紹</p>
<ul>
<li><p>grafana 是一個開源數據分析和視覺化圖形套件，常用在視覺化基礎設施的性能資料和應用程式分析的時間序列資料。</p>
</li>
<li><p>influxdb 是一款專為時序性資料開發的高性能資料庫，使用GO語言開發且開源！不同的是可以直接對 influxdb 用 curl 新增刪除修改資料。</p>
</li>
</ul>
<h1 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br></pre></td></tr></table></figure>
<p>用來取得遠端更新伺服器的套件檔案清單。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get upgrade</span><br></pre></td></tr></table></figure>
<p>自動找出所有有新版的軟體套件並逐一升級。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install docker.io</span><br></pre></td></tr></table></figure>
<p>下載docker</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo curl -L <span class="string">"https://github.com/docker/compose/releases/download/1.23.2/docker-compose-<span class="variable">$(uname -s)</span>-<span class="variable">$(uname -m)</span>"</span> -o /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure>
<p>下載docker-compose(用來定義容器之間的關係與容器啟動的順序)<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure></p>
<p>將剛剛下載的docker-compose的加上執行的權限<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkdir -p /data/influxdb /data/grafana</span><br></pre></td></tr></table></figure></p>
<p>新增資料夾，用來存在grafana與influxdb的資料(避免容器重啟後即消失)<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo chmod 777 /data/grafana /data/influxdb</span><br></pre></td></tr></table></figure></p>
<p>將資料夾權限開到所有帳號與服務皆可以寫入(不安全的做法，如可以的話請使用安全的權限寫入，如這邊無法寫入的話，容器將會因為啟動的時候要將資料寫入對應資料夾而失敗造成無線重試&amp;無限重啟)<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim docker-compose.yml</span><br></pre></td></tr></table></figure></p>
<p>編寫docker-compose的檔案</p>
<p>docker-compose內容如下(下列隱私資料我有改過，所以需要依照自己的去修正):</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">"3"</span></span><br><span class="line">services:</span><br><span class="line"></span><br><span class="line">  influxdb:</span><br><span class="line">    image: influxdb</span><br><span class="line">    container_name: influxdb</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">"8086:8086"</span></span><br><span class="line">    restart: always</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/influxdb:/var/lib/influxdb</span><br><span class="line">    networks:</span><br><span class="line">      - monitor</span><br><span class="line">  grafana:</span><br><span class="line">    image: grafana/grafana</span><br><span class="line">    container_name: grafana</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">"80:3000"</span></span><br><span class="line">    restart: always</span><br><span class="line">    networks:</span><br><span class="line">      - monitor</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/grafana:/var/lib/grafana</span><br><span class="line">    environment:</span><br><span class="line">      - GF_SERVER_ROOT_URL=http://grafana.monitor.com</span><br><span class="line">      - GF_AUTH_DISABLE_LOGIN_FORM=<span class="literal">false</span></span><br><span class="line">      - GF_AUTH_GOOGLE_ENABLED=<span class="literal">true</span></span><br><span class="line">      - GF_AUTH_GOOGLE_CLIENT_ID=012345678912-testestest.apps.googleusercontent.com</span><br><span class="line">      - GF_AUTH_GOOGLE_CLIENT_SECRET=rhtsjyrkjytjkydtjyjdyj</span><br><span class="line">      - GF_AUTH_GOOGLE_ALLOWED_DOMAINS=grafana.com</span><br><span class="line">      - GF_AUTH_GOOGLE_ALLOW_SIGN_UP=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  monitor:</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>容器服務</th>
<th style="text-align:left">Time</th>
</tr>
</thead>
<tbody>
<tr>
<td>version</td>
<td style="text-align:left">docker-compose的版本</td>
<td></td>
</tr>
<tr>
<td>services</td>
<td style="text-align:left">定義容器服務：influxdb與grafana</td>
<td></td>
</tr>
<tr>
<td>container_name</td>
<td style="text-align:left">給予容器的名稱</td>
<td></td>
</tr>
<tr>
<td>ports</td>
<td style="text-align:left">將外部主機對應至內部容器的Port設定</td>
<td></td>
</tr>
<tr>
<td>restart</td>
<td style="text-align:left">容器在非正常的關閉或者停止下會被自動給重新啟動</td>
<td></td>
</tr>
<tr>
<td>volumes</td>
<td style="text-align:left">容器可以持久化</td>
</tr>
<tr>
<td>networks</td>
<td style="text-align:left">新增一個monitors的網路，將容器的網路指定至monitor名稱的區網路下</td>
<td></td>
</tr>
<tr>
<td>environment</td>
<td style="text-align:left">設定grafana的設定檔環境變數</td>
<td></td>
</tr>
</tbody>
</table>
<p>備註：記得docker-compose是有縮排的，容器與容器階級皆的縮牌要相同，同理服務與環境變數的設定是需要相同的空白段落，要注意否有對齊。</p>
<p>environment細部講解：</p>
<ul>
<li>GF_SERVER_ROOT_URL</li>
</ul>
<p>指定grafana網站的使用網域，有購買網域給該grafana服務使用的話可以利用此設定</p>
<ul>
<li>GF_AUTH_DISABLE_LOGIN_FORM</li>
</ul>
<p>輸入帳號密碼功能的顯示，如果需要輸入帳號密碼與google第三方驗證登入同時存在的話這邊設定false</p>
<ul>
<li>GF_AUTH_GOOGLE_ENABLED</li>
</ul>
<p>開啟google第三方登入驗證功能</p>
<ul>
<li>GF_AUTH_GOOGLE_CLIENT_ID</li>
</ul>
<p>google驗證客端的ID。可以至GCP上的API和憑證中的憑證後點選建立憑證→OAuth用戶端ID建立後或給予一組用戶端ID可以填寫在此。注意這邊需要先到OAuth同意畫面新增已授權網域並選擇公開</p>
<ul>
<li>GF_AUTH_GOOGLE_CLIENT_SECRET</li>
</ul>
<p>google驗證客端的密碼，同上在建立OAuth2.0用戶端ID的時候會同時給予密碼。</p>
<ul>
<li>GF_AUTH_GOOGLE_ALLOWED_DOMAINS</li>
</ul>
<p>允許認證的登入的網域，也就是說你需要設定什麼帳號的網域登入google成功後才可以轉導登入進grafana</p>
<ul>
<li>GF_AUTH_GOOGLE_ALLOW_SIGN_UP</li>
</ul>
<p>允許google驗證登入</p>
<hr>
<p>docker-compose.yml檔案寫完之後存檔離開，準備要試著透過docker-compose啟動</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker-compose up -d</span><br></pre></td></tr></table></figure>
<p>檢查一下docker的容器狀況是否正常的啟動。<br>正常會出現像以下的容器STATUS的情況才對，告知你正常啟動的時間經過多久了<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker ps -a</span><br></pre></td></tr></table></figure></p>
<img src="/2019/03/27/docker-compose建立Grafana與Influxdb/01.png">
<hr>
<p><font color="red">異常判斷1</font>：docker-compose無法啟動成功<br>如果這時候發生無法啟動docker-compose的時候，一個可能是權限不足造成無法啟動<br>如果不是的話可能是檔案內容縮排或者設定有問題，可以先試著一個一個容器與設定拿掉後再試著啟動</p>
<p><font color="red">異常判斷2</font>：docker-compose無法執行<br>當下終端機的位置需要與docker-compose.yml所在的目錄位置是相同的，不然無法使用docker-compose的指令，因為當下的目錄無此docker-composeyml檔案所以無法執行</p>
<hr>
<h1 id="Acceptance"><a href="#Acceptance" class="headerlink" title="Acceptance"></a>Acceptance</h1><p>先開啟剛剛再docker-compose.yml所輸入的root url或者該機器的IP(防火牆記得開通設定80 Port)<br>就會出現該網站的登入畫面了</p>
<p>備註：如果有設定google網域登入驗證的話還是只能使用網域方式，否則轉導回網域的時候會失敗!!<br><img src="/2019/03/27/docker-compose建立Grafana與Influxdb/02.png"></p>
<p>先使用google帳號方式的登入後即可以看到內部Grafana的畫面了<br><img src="/2019/03/27/docker-compose建立Grafana與Influxdb/03.png"></p>
<p><font color="blue">###注意###</font><br>這邊使用google登入的方式進去會新增一個使用者且是權限最低的Viewer，導致你除了看什麼也無法做，因此後續需要登出使用預設最高管理者帳號進行權限調整</p>
<p>預設帳號 / 密碼 ：admin / admin</p>
<p>登入後前往configuration→server Admin後將點選Grafana的google使用者帳號，將Permissions提升到Grafana Admin的權限<br><img src="/2019/03/27/docker-compose建立Grafana與Influxdb/03.png"></p>
<p>後續即可以正常的登出使用google帳號進行登出入了!!</p>
<p>之後再把docker-compose.yml檔案內的- GF_AUTH_DISABLE_LOGIN_FORM修改為true<br>重新將容器啟動!!就可以將帳號密碼的輸入功能顯示給關閉了</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker-compose down</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo docker-compose up -d</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/03/27/docker-compose建立Grafana與Influxdb/" data-id="cjudnsztv0001vck0q6zo10zr" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-利用docker-compose建立Grafana與上傳圖片功能" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/" class="article-date">
  <time datetime="2019-03-25T16:14:36.000Z" itemprop="datePublished">2019-03-26</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/">利用docker-compose建立Grafana與上傳圖片功能</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><a href="https://docs.docker.com/compose/" target="_blank" rel="noopener"><img src="https://pingsreenidotnet.files.wordpress.com/2018/04/screen-shot-2018-03-31-at-11-37-39-pm.png?w=358&amp;h=205" alt="N|Solid"></a><br><a href="http://docs.grafana.org/guides/getting_started/" target="_blank" rel="noopener"><img src="https://icinga.com/wp-content/uploads/2018/03/grafana-logo.png" alt="Build Status"></a><br><img src="https://travis-ci.org/joemccann/dillinger.svg?branch=master" alt="Build Status"></p>
<h1 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker-compose"></a>docker-compose</h1><p>實務上一個服務，一定由眾多 service 共同運作。若只使用 docker run，則勢必寫 Bash 來管理 4 個 service，還必須考慮：</p>
<ul>
<li>4 個 service 必須在同一個虛擬 network 下</li>
<li>4 個 service 的啟動順序</li>
</ul>
<p>… 等問題。Docker 為此提出 Docker Compose 概念。在 docker-compose.yml 檔描述各 service 間的參數與關係，也就是 Infrastructure as Code。</p>
<ul>
<li>docker-compose.yml 檔案很小，只是文字檔而已</li>
<li>由於 docker-compose.yml 是文字檔，可以 git 版控</li>
</ul>
<p>間單的說，docker-compose.yml 就是 container 的管理文件，只是採用 code 形式描述</p>
<h1 id="Granafa-amp-Influxdb-amp-Telegraf"><a href="#Granafa-amp-Influxdb-amp-Telegraf" class="headerlink" title="Granafa &amp; Influxdb &amp; Telegraf"></a>Granafa &amp; Influxdb &amp; Telegraf</h1><ul>
<li><p>influxdb 是一款專為時序性資料開發的高性能資料庫，使用GO語言開發且開源！不同的是可以直接對 influxdb 用 curl 新增刪除修改資料。</p>
</li>
<li><p>telegraf 是用Go寫的代理程式，可以用在收集系統和服務的統計資料，它擁有輸入套件，可以直接從系統抓取指標數據，從第三方API獲得指標數據，甚至可以通過statsd和Kafka得到資料。它還具備输出套件，可以將採集的數據發送到各種資料庫儲存。比如InfluxDB，Graphite，OpenTSDB，Datadog，Librato，Kafka，MQTT，NSQ等等。支援 Linux  與 Windows。</p>
</li>
<li><p>grafana 是一個開源數據分析和視覺化圖形套件，常用在視覺化基礎設施的性能資料和應用程式分析的時間序列資料。</p>
</li>
</ul>
<blockquote>
<p>可以參考下方的網站來進行更細部了解與額外的設定<br>本文章只進行簡單的使用docker-compose建立grafana &amp; influxdb的建置<br>telegraf因容器的特性暫不加入與研究放進docker-compose內<br>額外的google cloud platform平台與網域需要事先申請與購買才能完成本篇章設定<br>當然也有不需要上述方法也可以完成設定，只需要在docker-compose修改設定</p>
</blockquote>
<h3 id="Tech研讀"><a href="#Tech研讀" class="headerlink" title="Tech研讀"></a>Tech研讀</h3><ul>
<li><a href="https://docs.docker.com/get-started/" target="_blank" rel="noopener">docker</a> - Docker is a platform for developers and sysadmins to develop, deploy, and run applications with containers.</li>
<li><a href="http://docs.grafana.org/installation/configuration/" target="_blank" rel="noopener">grafana</a> - The leading open source software for time series analytics.</li>
<li><a href="https://www.influxdata.com/time-series-platform/influxdb/" target="_blank" rel="noopener">influxdb</a> - InfluxData provides the leading time series platform to instrument, observe, learn and automate any system, application and business process across a variety of use cases.</li>
<li><a href="https://www.influxdata.com/time-series-platform/telegraf/" target="_blank" rel="noopener">telegraf</a> - Telegraf is part of the TICK Stack and is a plugin-driven server agent for collecting and reporting metrics. </li>
<li><a href="https://docs.docker.com/compose/" target="_blank" rel="noopener">docker-compose</a> - Compose is a tool for defining and running multi-container Docker applications.</li>
</ul>
<h1 id="Google-Cloud-Platform設定DNS與Oauth2與Storage"><a href="#Google-Cloud-Platform設定DNS與Oauth2與Storage" class="headerlink" title="Google Cloud Platform設定DNS與Oauth2與Storage"></a>Google Cloud Platform設定DNS與Oauth2與Storage</h1><p>step.1 先到GCP(google cloud platform的簡單)的控制台，點選左上邊的Menu菜單後選擇網路服務→Cloud DNS<br>在此建立區域<br><img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/01.png"><br>進入區域後新增紀錄集用來當作grafana網站的網域A紀錄(e.q:grafana.monitor.com)<br><img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/02.png"></p>
<p>step2. 再到GCP的Menu菜單點選API和服務→憑證，然後點選OAuth同意畫面新增你的Grafna網域<br>應用程式類型：公開<br>應用程式名稱：任意輸入(主要是在google驗證的時候所跳出來的顯示名稱，告知登入者此跳轉至應用登入)<br>支援電子郵件：輸入自己的E-mail信箱(顯示在同意畫面中，方便使用者尋求支援)<br>已授權網域：輸入個人的網域(e.q：假設grafana.monitor.com是你的網域那就只需要輸入monitor.com即可)<br>完成後儲存<br><img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/03.png"><br><img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/04.png"></p>
<p>step.3 再切回到憑證的畫面後，再點選建立憑證→OAuth用戶端ID→網路應用程式<br>名稱：給予一個名稱用來辨識此OAuth用戶端ID<br>已授權的重新導向 URI：依照上述例子輸入<a href="http://grafana.monitor.com/login/google" target="_blank" rel="noopener">http://grafana.monitor.com/login/google</a><br><img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/05.png"><br><img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/06.png"></p>
<p>step.4 之後到GCP的IAM管理員的頁面點選+建立服務帳戶<br><img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/07.png"></p>
<p>填寫服務帳號名稱：這邊可以設定為單一服務或功能型的名稱：grafana or storages for grafana等等…<br>服務帳戶說明：看個人願不願意輸入此服務帳戶的詳細資訊，避免日後太久回來忘記還是建議輸入一下<br><img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/08.png"><br>設定服務帳戶權限(可選項)：請選擇儲存空間的storages的物件建立者or物件管理員(至少確保有寫入權限)<br>點選繼續之後<br><img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/09.png"><br>再完成後記得點選下載json格式的金鑰，此金鑰為你所創立的服務帳號所授予寫入storage權限的証明<br>有了此金鑰檔案就可以有權限任意的往你的storage新增刪除物件了<br>所以金鑰要很小心的管理唷!!!<br><img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/10.png"><br>step.5 建立可以暫存圖片的storage bucket<br>點選GCP Menu的Storage 瀏覽器後，按下建立值區(就是bucket的意思)<br><img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/11.png"><br>名稱：因為GCP的bucket的特殊性，全世界的bucket不可以有相同的名稱，因此請自己取一個符合服務或功能性的名稱<br>如果出現重複名稱GCP會有紅色通知你需要更換名稱<br>預設儲存空間級別：依照個人需求，假設你上傳與下載圖片頻率越高，則使用Multi-Regional；反之則選擇約低層級就好<br>詳細的費用計算方法請參考<a href="https://cloud.google.com/storage/pricing/" target="_blank" rel="noopener">這裡</a></p>
<img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/12.png">
<h1 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h1><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get update</span><br></pre></td></tr></table></figure>
<p>用來取得遠端更新伺服器的套件檔案清單。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get upgrade</span><br></pre></td></tr></table></figure>
<p>自動找出所有有新版的軟體套件並逐一升級。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install docker.io</span><br></pre></td></tr></table></figure>
<p>下載docker</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo curl -L <span class="string">"https://github.com/docker/compose/releases/download/1.23.2/docker-compose-<span class="variable">$(uname -s)</span>-<span class="variable">$(uname -m)</span>"</span> -o /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure>
<p>下載docker-compose(用來定義容器之間的關係與容器啟動的順序)<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure></p>
<p>將剛剛下載的docker-compose的加上執行的權限<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo mkdir -p /data/influxdb /data/grafana</span><br></pre></td></tr></table></figure></p>
<p>新增資料夾，用來存在grafana與inlfuxdb的資料(避免容器重啟後即消失)<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo chmod 777 /data/grafana /data/influxdb</span><br></pre></td></tr></table></figure></p>
<p>將資料夾權限開到最大(不安全的做法，如可以的話請使用安全的權限寫入，如這邊無法寫入的話，容器將會因為啟動的時候要將資料寫入對應資料夾而失敗造成無限重啟)<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo vim docker-compose.yml</span><br></pre></td></tr></table></figure></p>
<font color="blue">請注意將你剛剛下載下載的json金鑰檔案放置在/data/grafana底下，因為容器內的路徑對應到外部的data/grafana資料夾下，因此丟到此路徑就可以讓容器讀取金鑰</font>

<p>編寫docker-compose的檔案</p>
<p>這樣一來就能讓grafana的服務存取金鑰內容後可以去跟storage做存取圖片的動作權限了</p>
<p>docker-compose內容如下…</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">"3"</span></span><br><span class="line">services:</span><br><span class="line"></span><br><span class="line">  influxdb:</span><br><span class="line">    image: influxdb</span><br><span class="line">    container_name: influxdb</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">"8086:8086"</span></span><br><span class="line">    restart: always</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/influxdb:/var/lib/influxdb</span><br><span class="line">    networks:</span><br><span class="line">      - monitor</span><br><span class="line">  grafana:</span><br><span class="line">    image: grafana/grafana</span><br><span class="line">    container_name: grafana</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">"80:3000"</span></span><br><span class="line">    restart: always</span><br><span class="line">    networks:</span><br><span class="line">      - monitor</span><br><span class="line">    volumes:</span><br><span class="line">      - /data/grafana:/var/lib/grafana</span><br><span class="line">    environment:</span><br><span class="line">      - GF_SERVER_ROOT_URL=http://grafana.costworlds.com</span><br><span class="line">      - GF_AUTH_DISABLE_LOGIN_FORM=<span class="literal">false</span></span><br><span class="line">      - GF_AUTH_GOOGLE_ENABLED=<span class="literal">true</span></span><br><span class="line">      - GF_AUTH_GOOGLE_CLIENT_ID=957269883000-82e4758ih5a74u9jj7rldc427lg67sfl.apps.googleusercontent.com</span><br><span class="line">      - GF_AUTH_GOOGLE_CLIENT_SECRET=A1dclGMsDOXepyv6oXhAfpMu</span><br><span class="line">      - GF_AUTH_GOOGLE_ALLOWED_DOMAINS=gosmio.biz</span><br><span class="line">      - GF_AUTH_GOOGLE_ALLOW_SIGN_UP=<span class="literal">true</span></span><br><span class="line">      - GF_EXTERNAL_IMAGE_STORAGE_PROVIDER=gcs</span><br><span class="line">      - GF_EXTERNAL_IMAGE_STORAGE_S3_BUCKET_URL=https://s3-ap-southeast-1.amazonaws.com/gt-to3</span><br><span class="line">      - GF_EXTERNAL_IMAGE_STORAGE_S3_ACCESS_KEY=AKIAIVBWSCYVD45MHWHQ</span><br><span class="line">      - GF_EXTERNAL_IMAGE_STORAGE_S3_SECRET_KEY=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</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  monitor:</span><br></pre></td></tr></table></figure>
<p>記得docker-compose是有縮排的，因此服務與環境變數之間的空白要注意否有對齊</p>
<p>再來準備安裝資料收集器：Telegraf<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://dl.influxdata.com/telegraf/releases/telegraf_1.9.5-1_amd64.deb</span><br></pre></td></tr></table></figure></p>
<p>下載Telegraf的安裝包<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo dpkg -i telegraf_1.9.5-1_amd64.deb</span><br></pre></td></tr></table></figure></p>
<p>解壓縮並安裝<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/telegraf/telegraf.conf</span><br></pre></td></tr></table></figure></p>
<p>修改設定檔<br>將config內的設定檔照以下的資訊設定完成</p>
<blockquote>
<p>logfile = “/var/log/telegraf/telegraf.log”</p>
<p>urls = [“<a href="http://127.0.0.1:8086&quot;]" target="_blank" rel="noopener">http://127.0.0.1:8086&quot;]</a></p>
<p>database = “telegraf”</p>
</blockquote>
<p>logfile：主要是將telegraf的log檔案指定在特定路徑下<br>urls：指定要telegraf將收集的資料丟往哪一個資料庫存放<br>database：指定在丟資料時要存放進哪一個資料庫<br>儲存好了之後重啟服務 &amp; 確認服務<font color="Green">Running</font></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ service telegraf restart</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ service telegraf status</span><br></pre></td></tr></table></figure>
<img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/24.png">
<h1 id="Dashboard-amp-Metric-amp-Alert-配置"><a href="#Dashboard-amp-Metric-amp-Alert-配置" class="headerlink" title="Dashboard &amp; Metric &amp; Alert 配置"></a>Dashboard &amp; Metric &amp; Alert 配置</h1><p>首先先開啟瀏覽器輸入剛剛你設定grafana的前台網址，然後會看到類似的登入畫面<br><img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/13.png"></p>
<p>這邊要注意的是因為在docker-compose把環境變數的- GF_AUTH_DISABLE_LOGIN_FORM設定false</p>
<p>所以還是會出現同帳號密碼的輸入畫面出現，如果不希望的話可以先用google登出入後再使用admin帳號進去將google的帳號權限拉升至admin管理者，再將變數修改為true後重啟docker-compose</p>
<p>預設帳號是admin / amdin</p>
<p>第一步驟是新增data source，也就是把Grafana新增資料的讀取來源Influxdb<br><img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/14.png"><br><img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/15.png"></p>
<p>第二步驟填寫Influxdb的連線資訊後儲存<br>URL：<a href="http://influxdb:8086(這邊要注意的是一定要寫influxdb唷，容器只互相認得容器名稱)" target="_blank" rel="noopener">http://influxdb:8086(這邊要注意的是一定要寫influxdb唷，容器只互相認得容器名稱)</a><br>Database：Telegraf<br><img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/16.png"></p>
<img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/17.png">
<img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/18.png">
<p>設定要抓取定特的值來視覺化，telegraf預設上已經有最基本的系統監控(CPU、記憶體、硬碟等)<br>因此這邊再queries to選擇data sourece，下方則是選擇此data source內的監控資料<br>下圖選擇cpu的監控值來顯示<br><img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/19.png"></p>
<p>之後我們來設定Alerting Channel讓Grafana發出告警到Slack並夾帶告警截圖<br><img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/22.png"><br>Slack Setting的部份需要個人去申請Slack的帳號後新開自己的Workplace(工作群組)後前往slack的app Directory應用程序去申請Incoming WebHooks的URL在這邊填上<br>網址：<a href="https://slack.com/apps" target="_blank" rel="noopener">https://slack.com/apps</a><br><img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/21.png"><br>再來開始設定Metric的Alert的告警水位與發送告警到Slack的頻道<br><img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/20.png"><br><img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/23.png"></p>
<h3 id="TEST"><a href="#TEST" class="headerlink" title="TEST"></a>TEST</h3><p>測試上述設定與安裝與配置都是成功的，成功會有告警的截圖傳送到Slack的頻道內<br>將水位調整成會出發告警之後查看剛剛新創立的slack頻道是否有出現Grafana告警的截圖與incoming webhook的告警通知</p>
<img src="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/25.png">

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/" data-id="cjudnszu00003vck063qyrmur" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/04/01/加入ping與snmp監控到telegraf/">加入ping與snmp監控到telegraf</a>
          </li>
        
          <li>
            <a href="/2019/03/28/Grafana搭配Slack告警與GCS圖片發送/">Grafana搭配Slack告警與GCS圖片發送</a>
          </li>
        
          <li>
            <a href="/2019/03/28/搭配Grafana的資料收集器Telegraf/">搭配Grafana的資料收集器Telegraf</a>
          </li>
        
          <li>
            <a href="/2019/03/27/docker-compose建立Grafana與Influxdb/">docker-compose建立Grafana與Influxdb</a>
          </li>
        
          <li>
            <a href="/2019/03/26/利用docker-compose建立Grafana與上傳圖片功能/">利用docker-compose建立Grafana與上傳圖片功能</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>